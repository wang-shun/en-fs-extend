<?xml version="1.0" encoding="UTF-8"?>
<form:Form xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:dync="http://www.chinacreator.com/platform/mvc/ui/dync" xmlns:form="http://www.chinacreator.com/platform/mvc/form" name="附件INROW" sn="qybdir_uploadfileinrow" type="form">
  <form:control type="page/normal">
    <form:attributes source="page/normal">
      <dync:attribute default="" group="HTML" id="showHead" name="显示标题" value="">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="" group="HTML" id="title" name="标题" value="">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="" group="HTML" id="desc" name="描述" value="">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="false" group="HTML" id="fixedHeight" name="自动高度" value="false">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="false" group="HTML" id="compact" name="紧凑页面" value="false">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="false" group="HTML" id="dirtyCheck" name="脏检查" value="false">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="" group="注入配置" id="angularJsServices" name="注入服务" value="">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="" group="事件" id="beforeDataSourceLoad" name="数据源加载前" value="">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="" group="事件" id="afterDataSourceLoad" name="数据源加载后" value="">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
      <dync:attribute default="" group="事件" id="onload" name="页面加载完成" value="page_onload()">
        <dync:render/>
        <dync:children/>
      </dync:attribute>
    </form:attributes>
  </form:control>
  <form:child xsi:type="form:Group" id="attchmentinrow" name="简单容器(DIV)">
    <form:control type="container/div">
      <form:attributes source="container/div">
        <dync:attribute default="false" group="HTML配置" id="nopadding" name="无内边距" value="true">
          <dync:render colSpan="2" height="0" multi="false" name="checkbox"/>
          <dync:children/>
        </dync:attribute>
        <dync:attribute default="" group="高级自定义" id="style" name="自定义style" value="border: 1px rgb(197, 197, 197) solid">
          <dync:render colSpan="2" height="0" multi="false" name="text"/>
          <dync:children/>
        </dync:attribute>
      </form:attributes>
    </form:control>
    <form:child xsi:type="form:Group" id="div3" name="简单容器(DIV)">
      <form:control type="container/div">
        <form:attributes source="container/div">
          <dync:attribute default="false" group="HTML配置" id="pure" name="简单div" value="true">
            <dync:render colSpan="2" height="0" multi="false" name="checkbox"/>
            <dync:children/>
          </dync:attribute>
          <dync:attribute default="" group="高级自定义" id="style" name="自定义style" value="width:110px">
            <dync:render colSpan="2" height="0" multi="false" name="text"/>
            <dync:children/>
          </dync:attribute>
          <dync:attribute default="" group="高级自定义" id="html" name="自定义HTML" value="div3_html">
            <dync:render colSpan="2" height="0" multi="false" name="html"/>
            <dync:children/>
          </dync:attribute>
        </form:attributes>
      </form:control>
    </form:child>
    <form:child xsi:type="form:Group" id="div4" name="简单容器(DIV)">
      <form:control type="container/div">
        <form:attributes source="container/div">
          <dync:attribute default="false" group="HTML配置" id="nopadding" name="无内边距" value="true">
            <dync:render colSpan="2" height="0" multi="false" name="checkbox"/>
            <dync:children/>
          </dync:attribute>
          <dync:attribute default="12" group="HTML配置" id="span" name="占位数" value="10">
            <dync:render colSpan="1" height="0" multi="false" name="text"/>
            <dync:children/>
          </dync:attribute>
          <dync:attribute default="" group="高级自定义" id="style" name="自定义style" value="border-left: 1px rgb(197, 197, 197) solid;">
            <dync:render colSpan="2" height="0" multi="false" name="text"/>
            <dync:children/>
          </dync:attribute>
        </form:attributes>
      </form:control>
      <form:child xsi:type="form:Field" id="fileInputIframeinrow" name="" customize="true">
        <form:control type="widget/file_input_iframe">
          <form:attributes source="widget/file_input_iframe">
            <dync:attribute default="75" group="布局属性" id="lableWidth" name="lable宽度" value="-12">
              <dync:render colSpan="1" height="0" multi="false" name="text"/>
              <dync:children/>
            </dync:attribute>
            <dync:attribute default="true" group="HTML属性" id="showRemoveButton" name="显示清除按钮" value="false">
              <dync:render colSpan="2" height="0" multi="false" name="checkbox"/>
              <dync:children/>
            </dync:attribute>
            <dync:attribute default="dbdir" group="HTML属性" id="process" name="上传处理器" value="qybdirprocess">
              <dync:render colSpan="1" height="0" multi="false" name="text"/>
              <dync:children/>
            </dync:attribute>
            <dync:attribute default="" group="事件" id="onSuccess" name="上传成功" value="fileInputIframeinrow_onSuccess(data)">
              <dync:render colSpan="2" height="0" multi="false" name="event">
                <dync:item name="params" value="data"/>
              </dync:render>
              <dync:children/>
            </dync:attribute>
            <dync:attribute default="true" group="HTML属性" id="show" name="可见" value="permissionData[$params.field.fieldNo].writePermission">
              <dync:render colSpan="1" height="0" multi="false" name="checkboxAndExpr"/>
              <dync:children/>
            </dync:attribute>
          </form:attributes>
        </form:control>
        <form:validation/>
      </form:child>
      <form:child xsi:type="form:Group" id="div5" name="简单容器(DIV)">
        <form:control type="container/div">
          <form:attributes source="container/div">
            <dync:attribute default="" group="高级自定义" id="html" name="自定义HTML" value="div5_html">
              <dync:render colSpan="2" height="0" multi="false" name="html"/>
              <dync:children/>
            </dync:attribute>
          </form:attributes>
        </form:control>
      </form:child>
    </form:child>
  </form:child>
  <form:datasources>
    <form:datasource xsi:type="form:Inputs"/>
    <form:datasource xsi:type="form:LogicDataSource" id="uploadfiles" name="上传的文件" logic="rule:com.chinacreator.c2.qyb.fs.services.getUploadFiles" sn="getuploadfiles">
      <form:param id="businessType" name="新输入参数" value="$params.businessType"/>
      <form:param id="businessKey" name="新输入参数" value="$params.businessKey"/>
      <form:param id="businessKey1" name="新输入参数" value="$params.businessKey1"/>
      <form:param id="businessKey2" name="新输入参数" value="$params.businessKey2"/>
      <form:param id="businessKey3" name="新输入参数" value="$params.businessKey3"/>
    </form:datasource>
  </form:datasources>
  <form:scripts>

page_onload:function(){
	$view.fileInputIframeinrow.setParams({
		businessType:$params.businessType,
		businessKey:$params.businessKey,
		businessKey1:$params.businessKey1,
		businessKey2:$params.businessKey2,
		businessKey3:$params.businessKey3,
	})
	functions.set_buttonlabel()
},

fileInputIframeinrow_onSuccess:function(data){
	functions.set_buttonlabel()
	$model.uploadfiles.$load().then(function(data){
		
	})
},

can_del:function(file){
//	return true
	return $scope.permissionData[$params.field.fieldNo].writePermission
},
can_download:function(file){
	return true
},
//处理文件下载
download:function(a){
	var paths = a.split(&quot;/&quot;)
	var name = paths[2]
	var newname = encodeURIComponent(name)
	var newa = paths[0]+&quot;/&quot;+paths[1]+&quot;/&quot;+newname
	$http({method : &quot;GET&quot;,url : &quot;iframefile/qybdirprocess/exist/&quot;+newa})
		.success(function(data,response, status, headers, config){
			if(1==data.status){
				 var downloadIframe=document.getElementById(&quot;downloadIframe&quot;);
				 if(!downloadIframe){
					 downloadIframe=document.createElement(&quot;iframe&quot;);
					 downloadIframe.id=&quot;downloadIframe&quot;;
					 downloadIframe.name=&quot;downloadIframe&quot;;
					 downloadIframe.style.display=&quot;none&quot;;
					 document.body.appendChild(downloadIframe);
				 }
				 downloadIframe.src=&quot;iframefile/qybdirprocess/download/&quot;+newa;
			}else{
				alert(&quot;文件不存在&quot;);
			}
		});
},
//处理文件删除
deletefile:function(a){
	var paths = a.filePath.split(&quot;/&quot;)
	var name = paths[2]
	var newname = encodeURIComponent(name)
	var newa = paths[0]+&quot;/&quot;+paths[1]+&quot;/&quot;+newname
	$http({method : &quot;DELETE&quot;,url : &quot;iframefile/qybdirprocess/&quot;+newa})
	.success(function(data,response, status, headers, config){
		if(1==data.status){
			$model.uploadfiles.$reload()
			Messenger.post({
			    'message': &quot;删除成功&quot;,
			    'type': 'success',
			});
		}else{
			$model.uploadfiles.$reload()
			Messenger.post({
			    'message': &quot;删除失败了&quot;,
			    'type': 'error',
			});
		}
   });
},
viewfile:function(file){
	var url = 'filepath=' + file.filePath;
	var newurl = encodeURI(url);
	window.open('showuploadfile.jsp?'+newurl);
},
set_buttonlabel:function(){
	$(&quot;#attchmentinrow span .ace-file-name&quot;).attr('data-title',&quot;添加附件...&quot;);
	$(&quot;#attchmentinrow span .ace-file-container&quot;).attr('data-title',&quot;上传...&quot;);
}</form:scripts>
  <form:htmls>&lt;script type=&quot;text/ng-template&quot; id=&quot;div3_html&quot;>
	&lt;label class=&quot;control-label al-control-label  ng-binding&quot; ng-style=&quot;{width:$params.field.labelWidth == undefined?110:$params.field.labelWidth}&quot; 
		ng-class=&quot;{'required-label':permissionData[$params.fieldNo].fillnecessary}&quot; >{{$params.field.displayName == undefined?$params.field.fieldName:$params.field.displayName}}&lt;/label>
&lt;/script>
&lt;script type=&quot;text/ng-template&quot; id=&quot;div5_html&quot;>
	&lt;div ng-repeat=&quot;a in $model.uploadfiles.result&quot;>
		&lt;a style=&quot;color: black&quot; ng-click=&quot;functions.viewfile(a)&quot;>{{a.displayName}}&lt;/a>
		&lt;a class=&quot;att_del&quot; ng-if=&quot;functions.can_download(file)&quot; ng-click=&quot;functions.download(a.filePath)&quot;>下载&lt;/a>
		&lt;a class=&quot;att_del&quot; ng-if=&quot;functions.can_del(file)&quot; ng-click=&quot;functions.deletefile(a)&quot;>删除&lt;/a>
	&lt;/div>
&lt;/script>
&lt;style>

&lt;/style></form:htmls>
</form:Form>
